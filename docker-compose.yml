version: '3.8'

# Platform selection:
#   Linux (default):  docker-compose up
#   Windows:          DOCKERFILE=Dockerfile.windows docker-compose up
#                     (PowerShell: $env:DOCKERFILE="Dockerfile.windows"; docker-compose up)

services:
  domain-checker:
    build:
      context: .
      dockerfile: ${DOCKERFILE:-Dockerfile.linux}
    container_name: domain-checker
    restart: unless-stopped
    volumes:
      # Mount data directory for results
      - ./data:/data
      # Mount the source database directly (read-only)
      - ../domain_variations.duckdb:/data/domain_variations.duckdb:ro
      # Mount proxies
      - ../proxies.txt:/data/proxies.txt:ro
    environment:
      - PYTHONUNBUFFERED=1
      - VARIATIONS_DB=/data/domain_variations.duckdb
      - CHECKS_DB=/data/domain_checks.duckdb
      - PROXY_FILE=/data/proxies.txt
      - RESUME=true
      - BATCH_SIZE=10000
      - CHECKPOINT_INTERVAL=100000
      # Adaptive rate control (optimized)
      - RATE_INITIAL_CONCURRENCY=500
      - RATE_MAX_CONCURRENCY=800
      - RATE_MIN_CONCURRENCY=50
      # Optional: limit proxies or domains
      # - MAX_PROXIES=500
      # - LIMIT=1000000
    # For long-running tasks, increase stop timeout
    stop_grace_period: 60s
    # Log configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
